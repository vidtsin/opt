# -*- coding: utf-8 -*-
# Part of Odoo. See LICENSE file for full copyright and licensing details.

import logging
import time
import babel
from datetime import datetime, timedelta
from odoo import api, fields, models,tools, _
from odoo.tools.translate import _

_logger = logging.getLogger(__name__)


class hr_employee(models.Model):
    # _name = "hr.employee"
    _description = "Employee"
    _inherit = "hr.employee"

    @api.one
    @api.depends('doc_count_id','doc_count_id.name')
    def _get_attached_docs(self):
        # res = {}
        #  res = dict(map(lambda x: (x, 0), self._ids))
        # attachment = self.env['ir.attachment']
        attachment = self.env['ir.attachment'].search([('doc_id','=',self.id)])
        for temp in self:
            # print"-------sale-------", temp
            self.doc_count = len(self.doc_count_id)
            # print"-------self.doc_count---------", self.doc_count
        # return res
        # for id in self._ids:
        #     print "-----------id--id-----------",id
        #     employee_attachments = attachment.search([('res_model', '=', 'hr.employee'), ('res_id', '=', id)],count=True)
        #     print "----employee_attachments----------",employee_attachments
        #     res[id] = employee_attachments or 0
        # return res

    doc_count = fields.Integer(compute='_get_attached_docs',string='Number of documents attached')
    doc_count_id = fields.One2many('ir.attachment','doc_id',string='Document Count')
    # document_id = fields.Many2one('ir.attachment' , string='Documents Attached')


    @api.multi
    def attachment_tree_view(self):
        # print "------------------------------------",self._context
        # print "------------------------------------",self._ids
        # print "-----------------------id-------------",self.id


        domain = ['&', ('res_model', '=', 'hr.employee'), ('res_id', 'in', [self.id])]
        # print "------------------domain---",domain
        res_id = self.id and self._ids[0] or False
        # print "====res_id========",res_id
        return {
            'name': _('Attachments'),
            'domain': domain,
            'res_model': 'ir.attachment',
            'type': 'ir.actions.act_window',
            'view_id': False,
            'view_mode': 'kanban,tree,form',
            'view_type': 'form',
            'limit': 80,
            'context': "{'default_res_model': '%s','default_res_id': %d}" % (self._name, res_id)
        }





    # _columns = {
    #     'doc_count': fields.function(_get_attached_docs, string="Number of documents attached", type='integer')
    # }
class hr_salary_rule(models.Model):
    _inherit = 'hr.salary.rule'

    is_gcc_app = fields.Boolean ('GCC Applicable')
    gcc_percent = fields.Float ('GCC variable Percent')

    @api.onchange('gcc_percent')
    def onchange_gcc_percent(self):
        if self.gcc_percent != 0.00 and self.gcc_percent:
            self.amount_select = 'code'
            gcc_percent_amount = float(self.gcc_percent/100)
            self.amount_python_compute = 'result =- (categories.BASIC + categories.ALW) *'+ str(gcc_percent_amount)

class hr_payroll_structure(models.Model):
    _inherit = 'hr.payroll.structure'

    applicable = fields.Selection([('saudi','Saudi'),
                                   ('non_saudi','Non Saudi'),('gcc','GCC')],string='Applicable for')

class hr_payslip(models.Model):
    _inherit = 'hr.payslip'

    @api.onchange ('employee_id', 'date_from', 'date_to')
    def onchange_employee(self):
        if (not self.employee_id) or (not self.date_from) or (not self.date_to):
            return

        employee = self.employee_id
        date_from = self.date_from
        date_to = self.date_to

        hr_payroll_s = self.env['hr.payroll.structure']


        ttyme = datetime.fromtimestamp(time.mktime(time.strptime(date_from, "%Y-%m-%d")))
        locale = self.env.context.get('lang', 'en_US')
        self.name = _('Salary Slip of %s for %s') % (employee.name, tools.ustr(babel.dates.format_date(date=ttyme, format='MMMM-y', locale=locale)))
        self.company_id = employee.company_id
        # gcc_contries=['Saudi Arabia', 'Kuwait','United Arab Emirates', 'Qatar', 'Bahrain', 'Oman']
        gcc_countries=['Kuwait','United Arab Emirates','Qatar','Bahrain','Oman']
        # print 'gcc_contries===================',gcc_contries
        if not self.env.context.get('contract') or not self.contract_id:
            contract_ids = self.get_contract(employee, date_from, date_to)
            if not contract_ids:
                return
            self.contract_id = self.env['hr.contract'].browse(contract_ids[0])

        if not self.contract_id.struct_id:
            return

        # print 'employee===========================', employee
        if employee.country_id:
            payroll_id = ''
            country = employee.country_id

            if country.name == 'Saudi Arabia':
                payroll_id = hr_payroll_s.search([('applicable','=','saudi')])[0]

            elif country.name in gcc_countries:
                payroll_id = hr_payroll_s.search ([('applicable', '=', 'gcc')])[0]

            else:
                payroll_id = hr_payroll_s.search ([('applicable', '=', 'non_saudi')])[0]

            self.struct_id = payroll_id.id

        else:
            print 'no country defined ========================='
            self.struct_id = self.contract_id.struct_id

        #computation of the salary input
        worked_days_line_ids = self.get_worked_day_lines(contract_ids, date_from, date_to)
        worked_days_lines = self.worked_days_line_ids.browse([])
        for r in worked_days_line_ids:
            worked_days_lines += worked_days_lines.new(r)
        self.worked_days_line_ids = worked_days_lines

        input_line_ids = self.get_inputs(contract_ids, date_from, date_to)
        input_lines = self.input_line_ids.browse([])
        for r in input_line_ids:
            input_lines += input_lines.new(r)
        self.input_line_ids = input_lines

        return


